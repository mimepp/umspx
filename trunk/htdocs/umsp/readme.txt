The whole UPnP process:

First we have to announce our presence to the WDTV via UDP broadcast by an SSDP packet (Simple Service Discovery Protocol)
The broadcast address is UDP 239.255.255.250:1900.
In our case this is done by simple netcat script that sends out a header file (mediaserver-notify-msg.txt) or a a one shot message via the web interface.
This header tells the WDTV that we are a UPnP media server and that our service description file can be found at "http://<wdtv-ip>/umsp/MediaServerServiceDesc.xml".

From here on everything is TCP/HTTP based and the files are served by our web server.

Based on the SSDP header and the service description file the WDTV now requests these files via HTTP:
"/umsp/MediaServerServiceDesc.xml"
"/umsp/MediaServerConnectionManager.xml"
"/umsp/MediaServerContentDirectory.xml"
The latter two are static and don't need to be altered.

Now we get to the interesting part. When you actually browse into our media server a HTTP-POST is made to
/umsp/control-reply.php (as defined in "MediaServerServiceDesc.xml").

This request contains something like this:
<Browse>
	<ObjectID>0</ObjectID>
	<BrowseFlag>BrowseDirectChildren</BrowseFlag>
	<StartingIndex>0</StartingIndex>
	<RequestedCount>64</RequestedCount>
</Browse>

So we have to reply with maximal 64 children of the object "0" (which is the root object)

The reply is generated by either a plugin or the local functions as an item array.
From this array a DIDL-XML file is generated and this is then enclosed in a SOAP-envelope-XML file and send back to the WDTV.

UPnP is quite simple isn't it ;)



